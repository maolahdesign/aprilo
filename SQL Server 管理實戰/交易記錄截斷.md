在 **SQL Server 2022**（與 **SSMS 20.2** 相容）中，**交易記錄備份（Transaction Log Backup）** 通常會**截斷（Truncate）交易記錄**，以釋放交易記錄檔（.ldf）的空間。然而，在某些特定情境下，交易記錄備份可能**不會導致交易記錄被截斷**，這可能導致交易記錄檔持續增長，進而影響資料庫效能或磁碟空間。以下詳細說明為什麼交易記錄備份不會被截斷的可能原因、機制，以及如何診斷和解決此問題，並結合前文討論的備份裝置、SSIS、資料庫角色等場景，提供實務應用。

---

### **一、什麼是交易記錄截斷？**

- **交易記錄（Transaction Log）**：
  - SQL Server 使用交易記錄來記錄所有資料庫操作（例如 `INSERT`、`UPDATE`、`DELETE`），確保資料一致性和可恢復性。
  - 交易記錄儲存在 `.ldf` 檔案中，隨著交易增加，檔案可能快速增長。

- **截斷（Truncation）**：
  - 截斷是指將交易記錄中**已不再需要的部分標記為可重用**，從而釋放空間，防止 `.ldf` 檔案無限增長。
  - 截斷**不縮小檔案大小**，僅標記空間為可重用；要縮小檔案需執行 `DBCC SHRINKFILE`。
  - 交易記錄備份通常會觸發截斷（在**完整恢復模式**或**大量記錄恢復模式**下）。

- **交易記錄備份與截斷的關係**：
  - 交易記錄備份會備份記錄中的活動交易（Active Transactions），並將已備份的記錄標記為可重用（截斷）。
  - 截斷確保交易記錄檔不會因長期運行而過大。

---

### **二、為什麼交易記錄備份不會被截斷？**

即使執行了交易記錄備份，交易記錄可能因為以下原因不會被截斷：

#### **1. 資料庫處於簡單恢復模式（Simple Recovery Model）**
- **原因**：
  - 在簡單恢復模式下，SQL Server 自動截斷交易記錄，無需交易記錄備份。
  - 交易記錄備份不適用於簡單恢復模式，因此執行 `BACKUP LOG` 會失敗，且不會觸發截斷。
- **影響**：
  - 交易記錄檔可能因自動檢查點（Checkpoint）而增長，直到被截斷。
  - 不支援時間點還原（參考前文差異備份與交易記錄備份的比較）。
- **診斷**：
  ```sql
  SELECT name, recovery_model_desc FROM sys.databases WHERE name = 'AdventureWorks2022';
  ```
  - 若 `recovery_model_desc` 顯示 `SIMPLE`，則不支援交易記錄備份。
- **解決方法**：
  - 切換到完整恢復模式（Full Recovery Model）：
    ```sql
    ALTER DATABASE AdventureWorks2022 SET RECOVERY FULL;
    ```
  - 執行完整備份以啟動備份鏈：
    ```sql
    BACKUP DATABASE AdventureWorks2022
    TO AdventureWorks_Backup
    WITH INIT;
    ```
  - 定期執行交易記錄備份：
    ```sql
    BACKUP LOG AdventureWorks2022
    TO DISK = 'C:\SQLBackups\AdventureWorks_Log.trn';
    ```

#### **2. 存在未提交的長時間運行交易（Long-Running Transactions）**
- **原因**：
  - SQL Server 無法截斷交易記錄中包含**活動交易（Active Transactions）**的部分。
  - 長時間運行交易（例如未提交的 `BEGIN TRANSACTION` 或大型批次操作）會阻止截斷，直到交易完成。
- **影響**：
  - 交易記錄檔持續增長，即使執行交易記錄備份。
- **診斷**：
  - 檢查活動交易：
    ```sql
    DBCC OPENTRAN('AdventureWorks2022');
    ```
    - 輸出顯示最舊的活動交易（Oldest Active Transaction）。
  - 查看交易記錄使用情況：
    ```sql
    DBCC SQLPERF(LOGSPACE);
    ```
    - 若 `Log Space Used (%)` 持續高，表示未截斷。
- **解決方法**：
  - 提交或回滾長時間交易：
    ```sql
    COMMIT TRANSACTION;
    -- 或
    ROLLBACK TRANSACTION;
    ```
  - 避免長時間運行批次，拆分為較小交易。
  - 執行交易記錄備份後再次檢查：
    ```sql
    BACKUP LOG AdventureWorks2022
    TO AdventureWorks_Backup;
    ```

#### **3. 資料庫複寫（Replication）或其他高可用性功能**
- **原因**：
  - 如果資料庫參與**交易複寫（Transactional Replication）**、**Always On 可用性群組**或**日誌傳送（Log Shipping）**，SQL Server 會保留交易記錄，直到相關交易被複寫或傳送到次要伺服器。
  - 交易記錄備份不會截斷未複寫的記錄。
- **影響**：
  - 交易記錄檔可能增長，直到複寫完成。
- **診斷**：
  - 檢查複寫狀態：
    ```sql
    SELECT * FROM sys.dm_repl_traninfo;
    ```
  - 查看未傳送的交易：
    ```sql
    EXEC sp_repltrans;
    ```
- **解決方法**：
  - 確保複寫代理程式（Replication Agent）正常運行：
    ```sql
    EXEC sp_replmonitorhelpsubscription @publisher = 'YourPublisherServer';
    ```
  - 修復複寫問題（例如同步延遲）。
  - 執行交易記錄備份並確認複寫完成。

#### **4. 資料庫鏡像（Database Mirroring）或 Always On 延遲**
- **原因**：
  - 在舊版資料庫鏡像（SQL Server 2012 及更早版本）或 Always On 可用性群組中，如果次要副本（Secondary Replica）未同步，交易記錄不會被截斷。
  - SQL Server 2022 主要使用 Always On，鏡像已棄用。
- **影響**：
  - 交易記錄檔增長，直到次要副本同步。
- **診斷**：
  - 檢查 Always On 同步狀態：
    ```sql
    SELECT database_name, synchronization_state_desc
    FROM sys.dm_hadr_database_replica_states;
    ```
    - 若 `synchronization_state_desc` 顯示 `NOT SYNCHRONIZED`，表示延遲。
- **解決方法**：
  - 確保次要副本正常運行（檢查網路或伺服器狀態）。
  - 暫停同步（若必要）並執行備份：
    ```sql
    ALTER AVAILABILITY GROUP YourAGName SUSPEND;
    BACKUP LOG AdventureWorks2022 TO AdventureWorks_Backup;
    ALTER AVAILABILITY GROUP YourAGName RESUME;
    ```

#### **5. 交易記錄備份未正確執行或損壞**
- **原因**：
  - 如果交易記錄備份失敗（例如磁碟空間不足、備份裝置無權限），SQL Server 不會截斷記錄。
  - 備份檔案損壞或中斷也可能導致問題。
- **影響**：
  - 交易記錄檔持續增長，備份鏈中斷。
- **診斷**：
  - 檢查備份歷史：
    ```sql
    SELECT * FROM msdb.dbo.backupset
    WHERE database_name = 'AdventureWorks2022' AND type = 'L';
    ```
  - 查看錯誤日誌：
    ```sql
    EXEC xp_readerrorlog;
    ```
- **解決方法**：
  - 確保備份裝置（參考前文）正確配置且 SQL Server 服務帳戶有寫入權限：
    ```sql
    EXEC sp_helpdevice 'AdventureWorks_Backup';
    ```
  - 執行完整備份以重置備份鏈：
    ```sql
    BACKUP DATABASE AdventureWorks2022 TO AdventureWorks_Backup WITH INIT;
    ```
  - 重新執行交易記錄備份：
    ```sql
    BACKUP LOG AdventureWorks2022 TO AdventureWorks_Backup;
    ```

#### **6. 其他限制（例如 CDC 或稽核）**
- **原因**：
  - **異動資料擷取（CDC, Change Data Capture）** 或 **SQL Server 稽核（Audit）** 可能保留交易記錄，直到相關資料被處理。
  - 這些功能依賴交易記錄追蹤變更，阻止截斷。
- **影響**：
  - 交易記錄檔增長，可能影響效能。
- **診斷**：
  - 檢查 CDC 狀態：
    ```sql
    SELECT * FROM sys.dm_cdc_log_scan_sessions;
    ```
  - 檢查稽核設定：
    ```sql
    SELECT * FROM sys.server_audits;
    ```
- **解決方法**：
  - 確保 CDC 擷取作業正常運行：
    ```sql
    EXEC sys.sp_cdc_help_jobs;
    ```
  - 停用或調整稽核設定（若非必要）：
    ```sql
    ALTER SERVER AUDIT YourAuditName WITH (STATE = OFF);
    ```

---

### **三、實際範例**

假設你在管理 **AdventureWorks2022** 資料庫（完整恢復模式），執行交易記錄備份，但發現 `.ldf` 檔案持續增長。

#### **情境**
- **資料庫**：`AdventureWorks2022`。
- **備份裝置**：`AdventureWorks_Backup`（路徑：`C:\SQLBackups\AdventureWorks.bak`）。
- **問題**：執行以下交易記錄備份後，交易記錄未截斷：
  ```sql
  BACKUP LOG AdventureWorks2022
  TO AdventureWorks_Backup;
  ```
- **檢查**：
  ```sql
  DBCC SQLPERF(LOGSPACE);
  ```
  - 顯示 `Log Space Used (%)` 接近 90%，未減少。

#### **診斷與解決**
1. **檢查恢復模式**：
   ```sql
   SELECT name, recovery_model_desc FROM sys.databases WHERE name = 'AdventureWorks2022';
   ```
   - 確認為 `FULL`（若為 `SIMPLE`，切換到 `FULL` 並執行完整備份）。

2. **檢查活動交易**：
   ```sql
   DBCC OPENTRAN('AdventureWorks2022');
   ```
   - 發現長時間運行交易（例如未提交的 `UPDATE`）。
   - **解決**：
     ```sql
     COMMIT TRANSACTION;
     BACKUP LOG AdventureWorks2022 TO AdventureWorks_Backup;
     ```

3. **檢查複寫**：
   ```sql
   EXEC sp_repltrans;
   ```
   - 發現未複寫的交易。
   - **解決**：啟動複寫代理程式並重新備份。

4. **檢查備份狀態**：
   ```sql
   SELECT * FROM msdb.dbo.backupset WHERE database_name = 'AdventureWorks2022' AND type = 'L';
   ```
   - 若無記錄，檢查備份是否失敗（例如權限問題）。
   - **解決**：確認備份裝置權限並重新執行。

5. **縮小檔案（若必要）**：
   - 若 `.ldf` 檔案過大，執行備份後縮小：
     ```sql
     DBCC SHRINKFILE (AdventureWorks2022_Log, 100);
     ```
   - **注意**：謹慎使用縮小，避免頻繁操作。

#### **結果**
- 交易記錄備份成功執行，`Log Space Used (%)` 降至低值（例如 10%）。
- `.ldf` 檔案空間可重用，停止異常增長。

---

### **四、與前文概念的整合**

1. **備份裝置（參考前文）**：
   - 交易記錄備份應使用備份裝置（例如 `AdventureWorks_Backup`）儲存：
     ```sql
     BACKUP LOG AdventureWorks2022 TO AdventureWorks_Backup;
     ```
   - 若備份失敗（例如權限問題），交易記錄不會截斷。確保 SQL Server 服務帳戶有寫入權限（參考前文備份裝置注意事項）。

2. **SSIS（參考前文 30 小時課程）**：
   - 使用 **Backup Database Task** 或 **Execute SQL Task** 自動化交易記錄備份（模組 6）。
   - 若交易記錄未截斷，SSIS 可透過 **Send Mail Task** 發送警報（模組 4）。
   - 範例：檢查交易記錄大小並備份：
     ```sql
     IF (SELECT log_reuse_wait_desc FROM sys.databases WHERE name = 'AdventureWorks2022') <> 'NOTHING'
     BEGIN
         BACKUP LOG AdventureWorks2022 TO AdventureWorks_Backup;
     END
     ```

3. **資料庫角色（參考前文）**：
   - 執行交易記錄備份的使用者需具備 `db_backupoperator` 角色：
     ```sql
     ALTER ROLE db_backupoperator ADD MEMBER backup_user;
     ```
   - 若權限不足，可能導致備份失敗，進而影響截斷。

4. **使用者類型（參考前文）**：
   - **基於登入的使用者**：備份帳戶（例如 `backup_user`）執行交易記錄備份。
   - **獨立使用者**：在獨立資料庫中，需確保具備備份權限。

---

### **五、注意事項**

1. **定期檢查**：
   - 使用 `DBCC SQLPERF(LOGSPACE)` 監控交易記錄使用率。
   - 設定 SQL Server Agent 作業，自動執行交易記錄備份並檢查截斷狀態。

2. **備份策略**：
   - 確保完整備份和交易記錄備份形成連續備份鏈，否則截斷可能失敗。
   - 結合差異備份（參考前文）優化備份計畫。

3. **避免誤解**：
   - **截斷 ≠ 縮小**：截斷僅標記空間可重用，不減少 `.ldf` 檔案大小。
   - 若需縮小檔案，使用 `DBCC SHRINKFILE`，但應謹慎操作以避免碎片化。

4. **高可用性環境**：
   - 在 Always On 或複寫環境中，優先解決同步問題，確保交易記錄可截斷。

5. **SSMS 20.2 支援**：
   - 使用「物件總管」 > 「管理」（Management） > 「維護計畫」（Maintenance Plans）配置自動交易記錄備份。
   - 檢查備份日誌：右鍵資料庫 > 「報表」（Reports） > 「備份與還原事件」。

---

### **六、結論**

交易記錄備份通常會截斷交易記錄，釋放 `.ldf` 檔案空間，但若資料庫處於簡單恢復模式、存在長時間交易、複寫延遲或其他限制，交易記錄可能不會被截斷，導致檔案增長。透過診斷工具（`DBCC OPENTRAN`、`DBCC SQLPERF`）和正確的備份策略（結合備份裝置和 SSIS 自動化），可以有效解決問題。與前文的資料庫角色和使用者類型整合，確保備份帳戶具備適當權限（如 `db_backupoperator`），提升備份可靠性。

如果需要更詳細的 T-SQL 腳本（例如自動檢查交易記錄狀態的 SSIS 封裝）或特定場景的解決方案（例如 Always On 環境），請提供細節，我可以進一步協助！